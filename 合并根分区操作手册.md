# openEuler RISC-V 根分区扩容操作手册

## ⚠️ 警告
- **高风险操作**：可能导致系统无法启动
- **必须有串口访问**：通过 Putty 连接串口
- **必须完整备份**：操作前确保备份完成
- **建议有人值班**：出问题时能物理访问机器

---

## 当前状态
```
/dev/mmcblk0p1    255M    /boot/efi
/dev/mmcblk0p2    4.8G    /           (100% 满，需要扩容)
/dev/mmcblk0p3    471.7G  (未使用)
```

## 目标状态
```
/dev/mmcblk0p1    255M    /boot/efi
/dev/mmcblk0p2    476G    /           (合并 p2 + p3)
```

---

## 阶段 1：备份（正常系统中操作）

### 1.1 完整备份根分区
```bash
# 备份整个根分区到 /remote-home
sudo rsync -avxHAX --progress / /remote-home/root_backup/

# 等待完成（大约需要 10-30 分钟）
```

### 1.2 验证备份
```bash
# 检查备份目录
ls -la /remote-home/root_backup/
du -sh /remote-home/root_backup/

# 验证关键文件
ls -la /remote-home/root_backup/etc/fstab
ls -la /remote-home/root_backup/boot/
ls -la /remote-home/root_backup/usr/bin/

# 应该看到约 4.4G 的备份数据
```

### 1.3 保存重要信息
```bash
# 记录当前 UUID（非常重要！）
sudo blkid /dev/mmcblk0p2 | tee /remote-home/mmcblk0p2_uuid.txt
cat /remote-home/mmcblk0p2_uuid.txt

# 备份 fstab
sudo cp /etc/fstab /remote-home/fstab.original
cat /remote-home/fstab.original

# 备份分区表
sudo fdisk -l /dev/mmcblk0 > /remote-home/partition_table.txt
lsblk > /remote-home/lsblk_before.txt
```

### 1.4 记录关键参数
```bash
# 记下这些信息（手写或截图）：
# - mmcblk0p2 的 UUID
# - mmcblk0p2 的起始扇区：524288
```

---

## 阶段 2：进入救援模式（串口操作）

### 2.1 重启系统
```bash
sudo reboot
```

### 2.2 在串口 Putty 中操作

**时间线：**
1. 系统重启，屏幕显示 BIOS/固件信息
2. 等待 5-10 秒
3. **看到 GRUB 菜单**（显示 "openEuler" 启动选项）
4. **立即按 'e' 键**（2-3 次，不要狂按）

### 2.3 编辑启动参数

看到类似界面：
```
setparams 'openEuler (6.6.0-27.0.0.31.oe2403.riscv64)'

load_video
set gfx_payload=keep
linux   /boot/vmlinuz-6.6.0... root=/dev/mmcblk0p2 ro quiet
        ↑ 找到这一行，移动光标到行尾
initrd  /boot/initramfs-6.6.0...
```

**操作：**
1. 用方向键移动到 `linux` 行的末尾
2. 在 `ro quiet` 后面添加：` rd.break`
3. 完整的行应该是：`linux /boot/vmlinuz... ro quiet rd.break`

### 2.4 启动进入救援模式
```
按 Ctrl+X 启动（不是 Enter）
```

### 2.5 进入 initramfs
几秒后看到：
```
switch_root:/#    ← 这是救援模式提示符
```

---

## 阶段 3：合并分区（救援模式中操作）

### 3.1 挂载文件系统
```bash
# 挂载根分区为读写
mount -o remount,rw /sysroot

# 挂载备份所在分区
mkdir -p /mnt/backup
mount /dev/nvme0n1p1 /mnt/backup

# 验证备份存在
ls /mnt/backup/root_backup/
```

### 3.2 卸载根分区准备操作
```bash
# 切换到备份分区
cd /mnt/backup

# 卸载根分区（重要！）
umount /sysroot
# 如果提示 busy，用：
umount -l /sysroot
```

### 3.3 重新分区（⚠️ 危险操作）
```bash
# 启动 fdisk
fdisk /dev/mmcblk0
```

**在 fdisk 中依次输入：**
```
Command (m for help): d           ← 删除分区
Partition number (1-3, default 3): 3    ← 删除 p3

Command (m for help): d           ← 删除分区
Partition number (1,2, default 2): 2    ← 删除 p2

Command (m for help): n           ← 新建分区
Partition type: p                 ← 主分区
Partition number: 2               ← 分区号 2
First sector: 524288              ← ⚠️ 必须是 524288！
Last sector: <直接回车>            ← 使用所有剩余空间

Command (m for help): p           ← 查看分区表（验证）
# 确认 p2 从 524288 开始，大小约 471G

Command (m for help): w           ← 写入并退出
```

### 3.4 格式化新分区
```bash
# 格式化新的 mmcblk0p2
mkfs.ext4 /dev/mmcblk0p2

# 等待完成（约 1-2 分钟）
```

### 3.5 挂载新分区
```bash
# 创建挂载点
mkdir -p /mnt/newroot

# 挂载新分区
mount /dev/mmcblk0p2 /mnt/newroot

# 验证
df -h /mnt/newroot
# 应该显示约 464G 可用
```

---

## 阶段 4：恢复数据

### 4.1 恢复备份
```bash
# 恢复数据到新分区（需要 10-30 分钟）
rsync -avxHAX --progress /mnt/backup/root_backup/ /mnt/newroot/

# 等待完成...
```

### 4.2 验证恢复
```bash
# 检查关键目录
ls -la /mnt/newroot/
ls -la /mnt/newroot/etc/
ls -la /mnt/newroot/boot/
ls -la /mnt/newroot/usr/bin/

# 确认文件完整
du -sh /mnt/newroot/
```

### 4.3 更新 fstab（重要！）
```bash
# 获取新分区的 UUID
NEW_UUID=$(blkid -s UUID -o value /dev/mmcblk0p2)
echo "新 UUID: $NEW_UUID"

# 方法 A：使用 sed 自动替换
sed -i "s|/dev/mmcblk0p2|UUID=$NEW_UUID|g" /mnt/newroot/etc/fstab

# 删除 mmcblk0p3 的行（如果存在）
sed -i '/mmcblk0p3/d' /mnt/newroot/etc/fstab

# 方法 B：手动编辑
vi /mnt/newroot/etc/fstab
# 或使用 nano（如果有）
# nano /mnt/newroot/etc/fstab

# 验证 fstab 内容
cat /mnt/newroot/etc/fstab
```

**fstab 应该类似：**
```
UUID=<新的UUID>  /  ext4  defaults  0  1
UUID=<EFI的UUID>  /boot/efi  vfat  defaults  0  2
/dev/nvme0n1p1  /remote-home  ext4  defaults  0  2
```

---

## 阶段 5：修复引导

### 5.1 准备 chroot 环境
```bash
# 挂载必要的伪文件系统
mount --bind /dev /mnt/newroot/dev
mount --bind /proc /mnt/newroot/proc
mount --bind /sys /mnt/newroot/sys
mount -t devpts devpts /mnt/newroot/dev/pts

# 挂载 EFI 分区
mount /dev/mmcblk0p1 /mnt/newroot/boot/efi

# 验证挂载
mount | grep newroot
```

### 5.2 进入 chroot
```bash
chroot /mnt/newroot /bin/bash
```

提示符应该变为：
```
bash-5.1#
```

### 5.3 重新安装 GRUB
```bash
# 检查架构
uname -m
# 应显示：riscv64

# 重新安装 GRUB（EFI 模式）
grub2-install --target=riscv64-efi --efi-directory=/boot/efi --bootloader-id=openEuler --recheck

# 重新生成配置
grub2-mkconfig -o /boot/grub2/grub.cfg

# 或者尝试另一个路径
grub2-mkconfig -o /boot/efi/EFI/openEuler/grub.cfg

# 验证配置文件
ls -la /boot/grub2/grub.cfg
cat /boot/grub2/grub.cfg | grep "root="
```

### 5.4 更新 initramfs（可选但推荐）
```bash
# 重新生成 initramfs
dracut -f -v

# 或指定内核版本
dracut -f /boot/initramfs-$(uname -r).img $(uname -r)
```

### 5.5 退出 chroot
```bash
exit
```

---

## 阶段 6：清理和重启

### 6.1 卸载所有挂载
```bash
# 按顺序卸载
umount /mnt/newroot/boot/efi
umount /mnt/newroot/dev/pts
umount /mnt/newroot/dev
umount /mnt/newroot/proc
umount /mnt/newroot/sys
umount /mnt/newroot
umount /mnt/backup

# 验证全部卸载
mount | grep mnt
# 应该没有输出
```

### 6.2 同步和重启
```bash
# 同步磁盘
sync

# 强制重启
reboot -f
```

---

## 阶段 7：验证（重启后）

### 7.1 观察启动过程
在串口中观察：
- 是否能看到 GRUB 菜单
- 是否正常启动内核
- 是否正常进入系统

### 7.2 登录后检查
```bash
# 检查根分区大小
df -h /
# 应该显示约 464G 可用

# 检查分区表
lsblk
# 应该只有 mmcblk0p1 和 mmcblk0p2，没有 p3

# 查看详细信息
sudo fdisk -l /dev/mmcblk0

# 检查文件系统
mount | grep "on / "

# 验证系统功能
systemctl status
```

### 7.3 清理备份（确认一切正常后）
```bash
# ⚠️ 只在确认系统完全正常后执行！
# 等待几天确认无问题

# 删除备份
sudo rm -rf /remote-home/root_backup/
sudo rm -f /remote-home/fstab.original
sudo rm -f /remote-home/mmcblk0p2_uuid.txt
sudo rm -f /remote-home/partition_table.txt
sudo rm -f /remote-home/lsblk_before.txt
```

---

## 故障恢复

### 如果启动失败：

1. **重启进入救援模式**（重复阶段 2）
2. **挂载分区：**
   ```bash
   mount /dev/mmcblk0p2 /mnt/newroot
   mount /dev/nvme0n1p1 /mnt/backup
   ```
3. **检查问题：**
   ```bash
   cat /mnt/newroot/etc/fstab
   ls /mnt/newroot/boot/
   ```
4. **重新修复 GRUB**（重复阶段 5）
5. **如果无法修复，重新恢复备份**（重复阶段 3-5）

### 如果完全无法启动：

1. 重新格式化分区
2. 重新恢复备份
3. 重新安装 GRUB
4. 联系管理员物理访问

---

## 检查清单

### 操作前：
- [ ] 完整备份根分区到 /remote-home
- [ ] 验证备份完整性
- [ ] 记录 mmcblk0p2 的 UUID
- [ ] 记录起始扇区：524288
- [ ] 串口 Putty 连接正常

### 操作中：
- [ ] 成功进入救援模式
- [ ] 成功删除并重建分区
- [ ] 起始扇区确认是 524288
- [ ] 成功格式化新分区
- [ ] 成功恢复备份数据
- [ ] 成功更新 fstab
- [ ] 成功重新安装 GRUB

### 操作后：
- [ ] 系统能正常启动
- [ ] 根分区约 464G 可用
- [ ] 只有 p1 和 p2，没有 p3
- [ ] 系统功能正常
- [ ] 等待数天确认稳定

---

## 时间估算

- 备份：10-30 分钟
- 进入救援模式：2-5 分钟
- 分区操作：5 分钟
- 格式化：1-2 分钟
- 恢复数据：10-30 分钟
- 修复引导：5-10 分钟
- **总计：约 45-90 分钟**

---

## 联系方式

如遇问题，立即联系：
- 系统管理员
- 机房值班人员

---

## 版本信息

- 文档版本：1.0
- 系统：openEuler 24.03 LTS RISC-V
- 创建日期：2025-10-22
- 最后更新：2025-10-22


